module.exports.config = {
  name: "joinNoti",
  eventType: ["log:subscribe"],
  version: "1.0.4",
  credits: "Mirai Team ",//modthem by tpk
  description: "ThÃ´ng bÃ¡o bot hoáº·c ngÆ°á»i vÃ o nhÃ³m",
  dependencies: {
    "fs-extra": ""
  }
};

module.exports.circle = async (image) => {
  const jimp = global.nodemodule["jimp"];
  image = await jimp.read(image);
  image.circle();
  return await image.getBufferAsync("image/png");
}
module.exports.run = async function({ api, event, Users }) {
  const { loadImage, createCanvas, registerFont } = require("canvas");
  const fontlink = 'https://drive.google.com/u/0/uc?id=1grxN6VBB7zdRCUISEoM72cp1UKXEDKtq&export=download'

  const moment = require("moment-timezone");
  const timeNow = moment.tz("Asia/Ho_Chi_Minh").format("DD/MM/YYYY || HH:mm:ss");
  const fs = require('fs-extra')
  var fullYear = global.client.getTime("fullYear");
  var getHours = await global.client.getTime("hours");
  var session = `${getHours < 3 ? "Ä‘Ãªm khuya" : getHours < 8 ? "buá»•i sÃ¡ng sá»›m" : getHours < 12 ? "buá»•i trÆ°a" : getHours < 17 ? "buá»•i chiá»u" : getHours < 23 ? "buá»•i tá»‘i" : "Ä‘Ãªm khuya"}`
  const { join } = global.nodemodule["path"];
  const { threadID } = event;
  if (event.logMessageData.addedParticipants.some(i => i.userFbId == api.getCurrentUserID())) {
    api.changeNickname(`[ ${global.config.PREFIX} ] â€¢ ${(!global.config.BOTNAME) ? "ððŽð“ ð“ð©ð¤ð“ƒ²" : global.config.BOTNAME}`, threadID, api.getCurrentUserID());
    const fs = require("fs");
    api.sendMessage("[ ð—žð—œð—˜Ì‚Ì‰ð—  ð——ð—¨ð—¬ð—˜Ì£Ì‚ð—§ ] â†’ ð—§ð—¶ð—²Ì‚Ìð—» ð—µð—®Ì€ð—»ð—µ ð—¸ð—¶ð—²Ì‚Ì‰ð—º ð˜ð—¿ð—® ð—±ð—®ð—»ð—µ ð˜€ð—®Ìð—°ð—µ ð—½ð—µð—²Ì‚ ð—±ð˜‚ð˜†ð—²Ì‚Ì£ð˜...", threadID, () => {
      setTimeout(function() {
        if (!(JSON.parse(require("fs-extra").readFileSync(__dirname + "/../commands/cache/approvedThreads.json"))).find(n => n == threadID)) api.sendMessage(`==ã€Ž ð—žð—˜Ì‚Ìð—§ ð—¡ð—¢Ì‚Ìð—œ ð—§ð—›ð—”Ì‚Ìð—§ ð—•ð—”Ì£ð—œ ã€==\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâ†’ ð—¦ð—®ð—¼ ð—¸ð—µð—¶ ð—¸ð—¶ð—²Ì‚Ì‰ð—º ð˜ð—¿ð—® ð˜ð—¿ð—¼ð—»ð—´ ð—±ð—®ð—»ð—µ ð˜€ð—®Ìð—°ð—µ ð—½ð—µð—²Ì‚ ð—±ð˜‚ð˜†ð—²Ì‚Ì£ð˜ ð—¯ð—¼ð˜ ð—½ð—µð—®Ìð˜ ð—µð—¶ð—²Ì‚Ì£ð—» ð—»ð—µð—¼Ìð—º ð—¯ð—®Ì£ð—» ð˜ƒð—®Ì‚Ìƒð—» ð—°ð—µð˜‚ð—® Ä‘ð˜‚Ì›ð—¼Ì›Ì£ð—° ð—®ð—±ð—ºð—¶ð—» ð—¯ð—¼ð˜ ð—±ð˜‚ð˜†ð—²Ì‚Ì£ð˜\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâ†’ ð—¡ð—²Ì‚Ìð˜‚ ð—¯ð—®Ì£ð—» ð—ºð˜‚ð—¼Ì‚Ìð—» Ä‘ð˜‚Ì›ð—¼Ì›Ì£ð—° ð—±ð˜‚ð˜†ð—²Ì‚Ì£ð˜ ð—±ð˜‚Ì€ð—»ð—´ ` + global.config.PREFIX + `duyetbox ðŸ’“\n\nâ°====ã€Œ${timeNow}ã€====â°`, threadID)
        else api.sendMessage(`==ã€Ž ð—žð—˜Ì‚Ìð—§ ð—¡ð—¢Ì‚Ìð—œ ð—§ð—›ð—”Ì€ð—¡ð—› ð—–ð—¢Ì‚ð—¡ð—š ã€==\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâ†’ ð—¦ð—®ð—¼ ð—¸ð—µð—¶ ð—¸ð—¶ð—²Ì‚Ì‰ð—º ð˜ð—¿ð—® ð˜ð—¿ð—¼ð—»ð—´ ð—±ð—®ð—»ð—µ ð˜€ð—®Ìð—°ð—µ ð—½ð—µð—²Ì‚ ð—±ð˜‚ð˜†ð—²Ì‚Ì£ð˜ ð—¯ð—¼ð˜ ð—½ð—µð—®Ìð˜ ð—µð—¶ð—²Ì‚Ì£ð—» ð—»ð—µð—¼Ìð—º ð—¯ð—®Ì£ð—» Ä‘ð—®Ìƒ Ä‘ð˜‚Ì›ð—¼Ì›Ì£ð—° ð—”ð—±ð—ºð—¶ð—» ð—±ð˜‚ð˜†ð—²Ì‚Ì£ð˜\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâ†’ ð—›ð—¶ð—²Ì‚Ì£ð—» ð˜ð—®Ì£ð—¶ ð—¯ð—¼ð˜ Ä‘ð—®ð—»ð—´ ð—°ð—¼Ì ${commands.size} ð—¹ð—²Ì‚Ì£ð—»ð—µ ðŸ’™\nâ†’ ð——ð˜‚Ì€ð—»ð—´ !ð—µð—²ð—¹ð—½ Ä‘ð—²Ì‚Ì‰ ð˜…ð—²ð—º ð˜ð—¼ð—®Ì€ð—» ð—¯ð—¼Ì‚Ì£ ð—¹ð—²Ì‚Ì£ð—»ð—µ ðŸ’›\nâ†’ !ð—µð—²ð—¹ð—½ + ð˜ð—²Ì‚ð—» ð—¹ð—²Ì‚Ì£ð—»ð—µ Ä‘ð—²Ì‚Ì‰ ð˜…ð—²ð—º ð—°ð—µð—¶ ð˜ð—¶ð—²Ì‚Ìð˜ ðŸ’œ\n\nâ°====ã€Œ${timeNow}ã€====â°`, threadID)
      }, 5000);
    })
  }
  else {
    try {
      const { createReadStream, existsSync, mkdirSync } = global.nodemodule["fs-extra"];
      const { loadImage, createCanvas } = require("canvas");
      const fs = global.nodemodule["fs-extra"];
      const axios = global.nodemodule["axios"];
      if (!fs.existsSync(__dirname + `/cache/1.ttf`)) {
        let getfont2 = (await axios.get(`https://drive.google.com/u/0/uc?id=1DuI-ou9OGEkII7n8odx-A7NIcYz0Xk9o&export=download`, { responseType: "arraybuffer" })).data;
        fs.writeFileSync(__dirname + `/cache/1.ttf`, Buffer.from(getfont2, "utf-8"));
      };

      var tpk = ["https://i.imgur.com/AHZ1qNh.jpeg",
        "https://i.imgur.com/qAEHIgA.jpeg",
        "https://i.imgur.com/7z7ywog.jpeg"];
      let threadInfo = await api.getThreadInfo(event.threadID);
      let pathImg = __dirname + "/cache/join.png";
      let pathAvt1 = __dirname + "/cache/Avtmot1.png";
      let { threadName, participantIDs } = await api.getThreadInfo(threadID);

      const threadData = global.data.threadData.get(parseInt(threadID)) || {};
      const path = join(__dirname, "cache", "joinGif");
      const pathGif = join(path, `hi.mp4`);

      var mentions = [], nameArray = [], memLength = [], iduser = [], i = 0;

      for (id in event.logMessageData.addedParticipants) {
        const userName = event.logMessageData.addedParticipants[id].fullName;
        iduser.push(event.logMessageData.addedParticipants[id].userFbId.toString());


        nameArray.push(userName);
        mentions.push({ tag: userName, id: event.senderID });
        memLength.push(participantIDs.length - i++);

        if (!global.data.allUserID.includes(id)) {
          await Users.createData(id, { name: userName, data: {} });
          global.data.userName.set(id, userName);
          global.data.allUserID.push(id);
          console.log(`CÃ³ TVM ${nameArray}`)
        }
      }
      memLength.sort((a, b) => a - b);
      var getData = await Users.getData(event.author)
      var nameAuthor = typeof getData.name == "undefined" ? "NgÆ°á»i dÃ¹ng tá»± vÃ o" : getData.name
      var background = [`${tpk}`];
      var rd = background[Math.floor(Math.random() * background.length)];
      let getAvtmot = (
        await axios.get(`https://graph.facebook.com/${iduser}/picture?height=1500&width=1500&access_token=463372798834978|csqGyA8VWtIhabZZt-yhEBStl9Y`,
          { responseType: "arraybuffer" }
        )
      ).data;
      fs.writeFileSync(pathAvt1, Buffer.from(getAvtmot, "utf-8"));
      tpk1 = await this.circle(pathAvt1);
      let getbackground = (
        await axios.get(`${rd}`, {
          responseType: "arraybuffer",
        })
      ).data;
      let baseImage = await loadImage(pathImg);
      let baseAvt1 = await loadImage(tpk1);
      //let baseAvt2 = await loadImage(pathAvt2);		
      //let basebox = await loadImage(pathbox);   
      let canvas = createCanvas(baseImage.width, baseImage.height);
      let ctx = canvas.getContext("2d");
      ctx.drawImage(baseImage, 0, 0, canvas.width, canvas.height);
      ctx.drawImage(baseAvt1, 70, 49, 221, 221);
      fs.writeFileSync(pathImg, Buffer.from(getbackground, "utf-8"));
      registerFont(__dirname + `/cache/1.ttf`, {
        family: "1"
      });
      ctx.font = `75px 1`;
      ctx.fillText(`Welcome to ${threadName}`, 900, 400);
      //ctx.drawImage(basebox, 550, 76, 173, 95);	
      //ctx.drawImage(baseAvt2, 550, 210, 175, 150);	
      const imageBuffer = canvas.toBuffer();
      fs.writeFileSync(pathImg, imageBuffer);
      fs.removeSync(pathAvt1);
      //fs.removeSync(pathbox);
      //fs.removeSync(pathAvt2);
      api.sendMessage({ body:/*`${threadName} \n${nameArray}\n${memLength}\n${nameAuthor}${fullYear}\n${session}\nhttps://www.facebook.com/${iduser}\n\nhttps://www.facebook.com/${event.author}`*/`cac`, attachment: fs.createReadStream(pathImg) }, event.threadID, () => fs.unlinkSync(pathImg));
    } catch (e) { return console.log(e) };
  }
}